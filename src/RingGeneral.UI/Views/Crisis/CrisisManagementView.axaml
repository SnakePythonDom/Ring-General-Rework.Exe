<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:RingGeneral.UI.ViewModels.Crisis"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="RingGeneral.UI.Views.Crisis.CrisisManagementView"
             x:DataType="vm:CrisisViewModel">

    <Design.DataContext>
        <vm:CrisisViewModel />
    </Design.DataContext>

    <Grid>
        <!-- Vue principale -->
        <ScrollViewer>
            <StackPanel Margin="30" Spacing="25">
                <!-- En-tÃªte -->
                <StackPanel Spacing="8">
                    <TextBlock Text="ðŸ”¥ GESTION DES CRISES" FontSize="28" FontWeight="Bold" Foreground="#e0e0e0"/>
                    <TextBlock Text="GÃ©rez les crises backstage et les communications stratÃ©giques" FontSize="14" Foreground="#888888"/>
                </StackPanel>

                <!-- Statistiques -->
                <Grid ColumnDefinitions="*,*,*,*">
                    <!-- Crises actives -->
                    <Border Grid.Column="0" Background="#1e293b" Padding="20" CornerRadius="8" Margin="0,0,6,0">
                        <StackPanel Spacing="8">
                            <TextBlock Text="ðŸ”¥ ACTIVES" FontSize="12" Foreground="#64748b" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding ActiveCrisesCount}" FontSize="32" FontWeight="Bold" Foreground="#f59e0b"/>
                            <TextBlock Text="Crises en cours" FontSize="11" Foreground="#94a3b8"/>
                        </StackPanel>
                    </Border>

                    <!-- Crises critiques -->
                    <Border Grid.Column="1" Background="#1e293b" Padding="20" CornerRadius="8" Margin="6,0,6,0">
                        <StackPanel Spacing="8">
                            <TextBlock Text="âš ï¸ CRITIQUES" FontSize="12" Foreground="#64748b" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding CriticalCrisesCount}" FontSize="32" FontWeight="Bold" Foreground="#ef4444"/>
                            <TextBlock Text="NÃ©cessitent action" FontSize="11" Foreground="#94a3b8"/>
                        </StackPanel>
                    </Border>

                    <!-- Crises rÃ©solues -->
                    <Border Grid.Column="2" Background="#1e293b" Padding="20" CornerRadius="8" Margin="6,0,6,0">
                        <StackPanel Spacing="8">
                            <TextBlock Text="âœ… RÃ‰SOLUES" FontSize="12" Foreground="#64748b" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding TotalCrisesResolved}" FontSize="32" FontWeight="Bold" Foreground="#10b981"/>
                            <TextBlock Text="Total historique" FontSize="11" Foreground="#94a3b8"/>
                        </StackPanel>
                    </Border>

                    <!-- Taux de succÃ¨s -->
                    <Border Grid.Column="3" Background="#065f46" Padding="20" CornerRadius="8" Margin="6,0,0,0">
                        <StackPanel Spacing="8">
                            <TextBlock Text="ðŸ“Š SUCCÃˆS" FontSize="12" Foreground="#d1fae5" FontWeight="SemiBold"/>
                            <TextBlock FontSize="32" FontWeight="Bold" Foreground="#34d399">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0:F0}%">
                                        <Binding Path="CommunicationSuccessRate"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock Text="Communications" FontSize="11" Foreground="#a7f3d0"/>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Crises Critiques (si existantes) -->
                <Border Background="#7f1d1d" Padding="20" CornerRadius="8" IsVisible="{Binding CriticalCrisesCount}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="âš ï¸ CRISES CRITIQUES - ACTION IMMÃ‰DIATE REQUISE" FontSize="14" Foreground="#fecaca" FontWeight="Bold"/>
                        <ItemsControl ItemsSource="{Binding CriticalCrises}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#991b1b" Padding="14,12" Margin="0,0,0,8" CornerRadius="6">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <TextBlock Grid.Column="0" Text="{Binding CrisisTypeIcon}" FontSize="20" Margin="0,0,12,0"/>
                                            <StackPanel Grid.Column="1" Spacing="4">
                                                <TextBlock Text="{Binding Description}" FontSize="13" Foreground="#fecaca" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                                <StackPanel Orientation="Horizontal" Spacing="10">
                                                    <TextBlock Text="{Binding StageLabel}" FontSize="11" Foreground="#fca5a5"/>
                                                    <TextBlock Text="â€¢" Foreground="#dc2626"/>
                                                    <TextBlock Text="{Binding SeverityLabel}" FontSize="11"/>
                                                </StackPanel>
                                            </StackPanel>
                                            <Button Grid.Column="2" Content="ðŸ“ž Intervenir"
                                                    Command="{Binding $parent[UserControl].DataContext.OpenCommunicationDialogCommand}"
                                                    CommandParameter="{Binding}"
                                                    Padding="12,8"
                                                    Background="#dc2626"
                                                    Foreground="White"
                                                    CornerRadius="6"
                                                    Margin="12,0,0,0"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Liste des Crises Actives -->
                <Border Background="#1e293b" Padding="25" CornerRadius="8">
                    <StackPanel Spacing="16">
                        <!-- En-tÃªte -->
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Text="ðŸ“‹ CRISES ACTIVES" FontSize="16" Foreground="#64748b" FontWeight="SemiBold"/>
                                <TextBlock FontSize="12" Foreground="#94a3b8">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}GÃ©rez les {0} crises en cours">
                                            <Binding Path="ActiveCrisesCount"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </StackPanel>
                            <Button Grid.Column="1" Command="{Binding RefreshDataCommand}"
                                    Content="ðŸ”„ RafraÃ®chir"
                                    Padding="10,8"
                                    Background="#334155"
                                    Foreground="White"
                                    CornerRadius="6"/>
                        </Grid>

                        <!-- Liste -->
                        <ItemsControl ItemsSource="{Binding ActiveCrises}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#0f172a" Padding="16,14" Margin="0,0,0,10" CornerRadius="6">
                                        <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                                            <!-- IcÃ´ne et Type -->
                                            <StackPanel Grid.Column="0" Spacing="4" Margin="0,0,16,0" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding CrisisTypeIcon}" FontSize="28" HorizontalAlignment="Center"/>
                                                <TextBlock Text="{Binding CrisisType}" FontSize="9" Foreground="#64748b" HorizontalAlignment="Center"/>
                                            </StackPanel>

                                            <!-- Informations principales -->
                                            <StackPanel Grid.Column="1" Spacing="6">
                                                <TextBlock Text="{Binding Description}" FontSize="14" Foreground="#cbd5e1" FontWeight="SemiBold" TextWrapping="Wrap"/>

                                                <!-- DÃ©tails -->
                                                <StackPanel Orientation="Horizontal" Spacing="12">
                                                    <!-- Stage -->
                                                    <Border Padding="6,3" Background="#334155" CornerRadius="4">
                                                        <TextBlock Text="{Binding StageLabel}" FontSize="10" Foreground="{Binding StageColor}" FontWeight="SemiBold"/>
                                                    </Border>

                                                    <!-- SÃ©vÃ©ritÃ© -->
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <TextBlock Text="SÃ©vÃ©ritÃ©:" FontSize="10" Foreground="#94a3b8"/>
                                                        <TextBlock Text="{Binding SeverityLabel}" FontSize="10"/>
                                                    </StackPanel>

                                                    <!-- Tentatives -->
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <TextBlock Text="Tentatives:" FontSize="10" Foreground="#94a3b8"/>
                                                        <TextBlock Text="{Binding ResolutionAttempts}" FontSize="10" Foreground="#fbbf24"/>
                                                    </StackPanel>
                                                </StackPanel>

                                                <!-- Barre d'escalade -->
                                                <StackPanel Spacing="3">
                                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                                        <TextBlock Grid.Column="0" Text="Escalade:" FontSize="10" Foreground="#94a3b8" Margin="0,0,8,0"/>
                                                        <TextBlock Grid.Column="1" Text="{Binding EscalationBar}" FontSize="10" Foreground="{Binding EscalationColor}" FontFamily="Consolas"/>
                                                        <TextBlock Grid.Column="2" Text="{Binding EscalationScore}" FontSize="10" FontWeight="Bold" Foreground="{Binding EscalationColor}" Margin="8,0,0,0"/>
                                                    </Grid>
                                                </StackPanel>

                                                <!-- Date de crÃ©ation -->
                                                <TextBlock Text="{Binding CreatedAtFormatted}" FontSize="9" Foreground="#475569"/>
                                            </StackPanel>

                                            <!-- Badge critique (si applicable) -->
                                            <Border Grid.Column="2" IsVisible="{Binding IsCritical}"
                                                    Padding="8,4"
                                                    Background="#dc2626"
                                                    CornerRadius="4"
                                                    Margin="12,0,12,0"
                                                    VerticalAlignment="Center">
                                                <TextBlock Text="âš ï¸ CRITIQUE" FontSize="10" Foreground="White" FontWeight="Bold"/>
                                            </Border>

                                            <!-- Actions -->
                                            <StackPanel Grid.Column="3" Spacing="6" VerticalAlignment="Center">
                                                <Button Content="ðŸ“ž Communiquer"
                                                        Command="{Binding $parent[UserControl].DataContext.OpenCommunicationDialogCommand}"
                                                        CommandParameter="{Binding}"
                                                        Padding="10,6"
                                                        Background="#3b82f6"
                                                        Foreground="White"
                                                        CornerRadius="6"
                                                        FontSize="11"/>
                                                <Button Content="â¬†ï¸ Escalader"
                                                        Command="{Binding $parent[UserControl].DataContext.EscalateCrisisCommand}"
                                                        CommandParameter="{Binding}"
                                                        Padding="10,6"
                                                        Background="#64748b"
                                                        Foreground="White"
                                                        CornerRadius="6"
                                                        FontSize="11"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Message si aucune crise -->
                        <Border IsVisible="{Binding !ActiveCrisesCount}" Background="#0f172a" Padding="30,20" CornerRadius="6">
                            <StackPanel Spacing="8" HorizontalAlignment="Center">
                                <TextBlock Text="âœ…" FontSize="48" HorizontalAlignment="Center"/>
                                <TextBlock Text="Aucune crise active" FontSize="16" Foreground="#10b981" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                                <TextBlock Text="Tout va bien dans la compagnie !" FontSize="12" Foreground="#64748b" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Dialogue de Communication (Overlay) -->
        <Border IsVisible="{Binding IsCommunicationDialogOpen}"
                Background="#CC000000"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Border Background="#1e293b"
                    Padding="30"
                    CornerRadius="12"
                    MaxWidth="600"
                    MaxHeight="700"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel Spacing="20">
                    <!-- Titre -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="ðŸ“ž COMMUNICATION DE CRISE" FontSize="20" FontWeight="Bold" Foreground="#e0e0e0"/>
                        <TextBlock Text="{Binding SelectedCrisis.Description}" FontSize="13" Foreground="#94a3b8" TextWrapping="Wrap"/>
                    </StackPanel>

                    <!-- Recommandations -->
                    <Border Background="#065f46" Padding="14,12" CornerRadius="6">
                        <StackPanel Spacing="6">
                            <TextBlock Text="ðŸ’¡ RECOMMANDATIONS IA" FontSize="12" Foreground="#d1fae5" FontWeight="SemiBold"/>
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="Type:" FontSize="11" Foreground="#a7f3d0"/>
                                    <TextBlock Text="{Binding RecommendedType}" FontSize="11" FontWeight="Bold" Foreground="#34d399"/>
                                </StackPanel>
                                <TextBlock Text="â€¢" Foreground="#10b981"/>
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="Ton:" FontSize="11" Foreground="#a7f3d0"/>
                                    <TextBlock Text="{Binding RecommendedTone}" FontSize="11" FontWeight="Bold" Foreground="#34d399"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Type de Communication -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="TYPE DE COMMUNICATION" FontSize="11" Foreground="#64748b" FontWeight="SemiBold"/>
                        <ComboBox ItemsSource="{Binding CommunicationTypes}"
                                  SelectedItem="{Binding SelectedCommunicationType}"
                                  Background="#0f172a"
                                  Foreground="#e0e0e0"
                                  Padding="12,8"/>
                    </StackPanel>

                    <!-- Ton -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="TON" FontSize="11" Foreground="#64748b" FontWeight="SemiBold"/>
                        <ComboBox ItemsSource="{Binding CommunicationTones}"
                                  SelectedItem="{Binding SelectedTone}"
                                  Background="#0f172a"
                                  Foreground="#e0e0e0"
                                  Padding="12,8"/>
                    </StackPanel>

                    <!-- Message -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="MESSAGE" FontSize="11" Foreground="#64748b" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding CommunicationMessage, Mode=TwoWay}"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MinHeight="100"
                                 Background="#0f172a"
                                 Foreground="#e0e0e0"
                                 Padding="12,10"
                                 Watermark="RÃ©digez votre message..."/>
                    </StackPanel>

                    <!-- PrÃ©diction de succÃ¨s -->
                    <Border Background="#0f172a" Padding="14,12" CornerRadius="6">
                        <StackPanel Spacing="8">
                            <TextBlock Text="CHANCE DE SUCCÃˆS PRÃ‰DITE" FontSize="11" Foreground="#64748b" FontWeight="SemiBold"/>
                            <Grid ColumnDefinitions="*,Auto">
                                <ProgressBar Grid.Column="0"
                                             Value="{Binding PredictedSuccessChance}"
                                             Maximum="100"
                                             Height="12"
                                             Foreground="#10b981"
                                             Background="#1e293b"/>
                                <TextBlock Grid.Column="1"
                                           FontSize="20"
                                           FontWeight="Bold"
                                           Foreground="#10b981"
                                           Margin="12,0,0,0">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0}%">
                                            <Binding Path="PredictedSuccessChance"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Boutons d'action -->
                    <Grid ColumnDefinitions="*,*">
                        <Button Grid.Column="0"
                                Command="{Binding CancelCommunicationCommand}"
                                Content="âŒ Annuler"
                                Padding="12,10"
                                Background="#475569"
                                Foreground="White"
                                CornerRadius="6"
                                Margin="0,0,6,0"
                                FontSize="13"
                                FontWeight="SemiBold"/>
                        <Button Grid.Column="1"
                                Command="{Binding SendCommunicationCommand}"
                                Content="ðŸ“¤ Envoyer Communication"
                                Padding="12,10"
                                Background="#10b981"
                                Foreground="White"
                                CornerRadius="6"
                                Margin="6,0,0,0"
                                FontSize="13"
                                FontWeight="SemiBold"/>
                    </Grid>
                </StackPanel>
            </Border>
        </Border>
    </Grid>

</UserControl>
