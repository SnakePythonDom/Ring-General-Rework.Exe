<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls.DataGrid"
        mc:Ignorable="d"
        x:Class="RingGeneral.UI.Views.MainWindow"
        Width="1280"
        Height="720"
        Title="Ring General">
  <Window.KeyBindings>
    <KeyBinding Gesture="Ctrl+K" Command="{Binding Session.OuvrirRechercheGlobaleCommand}" />
    <KeyBinding Gesture="Escape" Command="{Binding Session.FermerRechercheGlobaleCommand}" />
  </Window.KeyBindings>
  <Grid RowDefinitions="Auto,*" ColumnDefinitions="280,*">
    <Border Grid.Row="0" Grid.ColumnSpan="2" Background="#1F2937" Padding="16,12">
      <DockPanel>
        <TextBlock Text="Ring General" Foreground="White" FontWeight="Bold" DockPanel.Dock="Left" />
        <ItemsControl ItemsSource="{Binding TopbarActions}" DockPanel.Dock="Left" Margin="12,0,0,0">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <StackPanel Orientation="Horizontal" />
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <Button Content="{Binding Libelle}" Tag="{Binding Id}" Margin="4,0,0,0"
                      ToolTip.Tip="{Binding Tooltip}" Click="OnTopbarAction" />
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
        <ItemsControl ItemsSource="{Binding TopbarIndicators}" DockPanel.Dock="Right">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <StackPanel Orientation="Horizontal" />
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <Border Background="#111827" Padding="8,4" Margin="4,0">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="{Binding Libelle}" Foreground="#9CA3AF" Margin="0,0,6,0" />
                  <TextBlock Text="{Binding Valeur}" Foreground="White" FontWeight="Bold" />
                </StackPanel>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </DockPanel>
    </Border>

    <Border Grid.Row="1" Grid.Column="0" Background="#111827" Padding="12">
      <ScrollViewer>
        <StackPanel Spacing="8">
          <ItemsControl ItemsSource="{Binding Sidebar}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <StackPanel Spacing="4">
                  <Button Content="{Binding Libelle}" Tag="{Binding Route}" Click="OnOuvrirPage"
                          Foreground="White" FontWeight="SemiBold" Background="Transparent"
                          HorizontalContentAlignment="Left" />
                  <ItemsControl ItemsSource="{Binding SousSections}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="#1F2937" Padding="8,6" CornerRadius="6">
                          <Button Content="{Binding Libelle}" Tag="{Binding Route}" Click="OnOuvrirPage"
                                  Foreground="#E5E7EB" Background="Transparent"
                                  HorizontalContentAlignment="Left" />
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </StackPanel>
      </ScrollViewer>
    </Border>

    <Border Grid.Row="1" Grid.Column="1" Background="#0B1220" Padding="24">
      <ScrollViewer>
          <StackPanel Spacing="20">
          <Border Background="#111827" Padding="12" CornerRadius="8" IsVisible="{Binding Session.AideOuverte}">
            <StackPanel Spacing="8">
              <DockPanel>
                <TextBlock Text="{Binding Session.AidePanel.Titre}" Foreground="White" FontWeight="Bold" DockPanel.Dock="Left" />
                <Button Content="Fermer" DockPanel.Dock="Right" Click="OnFermerAide" />
              </DockPanel>
              <TextBlock Text="{Binding Session.AidePanel.Resume}" Foreground="#CBD5F5" TextWrapping="Wrap" />
              <ItemsControl ItemsSource="{Binding Session.AidePanel.Sections}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Spacing="2" Margin="0,6,0,0">
                      <TextBlock Text="{Binding Titre}" Foreground="#F9FAFB" FontWeight="SemiBold" />
                      <TextBlock Text="{Binding Contenu}" Foreground="#D1D5DB" TextWrapping="Wrap" />
                    </StackPanel>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <ItemsControl ItemsSource="{Binding Session.AidePanel.ErreursFrequentes}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding .}" Foreground="#FBBF24" TextWrapping="Wrap" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Page sélectionnée" FontSize="20" FontWeight="Bold" Foreground="White" />
              <TextBlock Grid.Column="1" Text="{Binding PageSelectionnee.Meta.PageId}" Foreground="#9CA3AF" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="8">
                <TextBlock Text="{Binding PageSelectionnee.Meta.Titre}" Foreground="White" FontWeight="SemiBold" />
                <StackPanel Spacing="4">
                  <TextBlock Text="Onglets" Foreground="#9CA3AF" />
                  <ItemsControl ItemsSource="{Binding PageSelectionnee.Onglets}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal" />
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="#1F2937" Padding="6,2" CornerRadius="6" Margin="0,0,6,0">
                          <TextBlock Text="{Binding Libelle}" Foreground="#E5E7EB" />
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
                <StackPanel Spacing="4">
                  <TextBlock Text="Filtres" Foreground="#9CA3AF" />
                  <ItemsControl ItemsSource="{Binding PageSelectionnee.Filtres}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding .}" Foreground="#CBD5F5" />
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
                <StackPanel Spacing="4">
                  <TextBlock Text="Tables" Foreground="#9CA3AF" />
                  <ItemsControl ItemsSource="{Binding PageSelectionnee.Tables}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <StackPanel Spacing="2" Margin="0,4,0,0">
                          <TextBlock Text="{Binding Libelle}" Foreground="#F9FAFB" FontWeight="SemiBold" />
                          <ItemsControl ItemsSource="{Binding Colonnes}">
                            <ItemsControl.ItemTemplate>
                              <DataTemplate>
                                <TextBlock Text="{Binding .}" Foreground="#9CA3AF" />
                              </DataTemplate>
                            </ItemsControl.ItemTemplate>
                          </ItemsControl>
                        </StackPanel>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
                <StackPanel Spacing="4">
                  <TextBlock Text="Actions" Foreground="#9CA3AF" />
                  <ItemsControl ItemsSource="{Binding PageSelectionnee.Actions}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal" />
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="#1F2937" Padding="6,2" CornerRadius="6" Margin="0,0,6,0">
                          <TextBlock Text="{Binding Libelle}" Foreground="#E5E7EB" />
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
                <StackPanel Spacing="4">
                  <TextBlock Text="Avertissements" Foreground="#9CA3AF" />
                  <ItemsControl ItemsSource="{Binding PageSelectionnee.Warnings}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding .}" Foreground="#FBBF24" />
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
                <StackPanel Spacing="4">
                  <TextBlock Text="État vide" Foreground="#9CA3AF" />
                  <TextBlock Text="{Binding PageSelectionnee.EtatVide}" Foreground="#CBD5F5" />
                </StackPanel>
                <StackPanel Spacing="4">
                  <TextBlock Text="Messages d'erreur" Foreground="#9CA3AF" />
                  <ItemsControl ItemsSource="{Binding PageSelectionnee.MessagesErreur}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding .}" Foreground="#F87171" />
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Sauvegardes" FontSize="20" FontWeight="Bold" Foreground="White" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="8">
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <TextBox Width="220" Watermark="Nom de la sauvegarde" Text="{Binding Saves.NouveauNom, Mode=TwoWay}" />
                  <Button Content="Nouvelle partie" Click="OnNouvelleSauvegarde" />
                  <Button Content="Charger" Click="OnChargerSauvegarde" />
                </StackPanel>
                <ListBox ItemsSource="{Binding Saves.Sauvegardes}" SelectedItem="{Binding Saves.SauvegardeSelectionnee, Mode=TwoWay}" MaxHeight="180">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Border Background="#1F2937" Padding="8,6" CornerRadius="6">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                          <TextBlock Text="{Binding Nom}" Foreground="White" />
                          <TextBlock Text="{Binding DerniereModificationLabel}" Foreground="#9CA3AF" />
                          <TextBlock Text="Active" Foreground="#34D399" IsVisible="{Binding EstCourante}" />
                        </StackPanel>
                      </Border>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <Button Content="Exporter base" Click="OnExporterDb" />
                  <Button Content="Importer base" Click="OnImporterDb" />
                  <Button Content="Exporter pack" Click="OnExporterPack" />
                  <Button Content="Importer pack" Click="OnImporterPack" />
                </StackPanel>
                <TextBlock Text="{Binding Saves.StatutMessage}" Foreground="{Binding Saves.StatutCouleur}" TextWrapping="Wrap" />
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Booking" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="page.booking" Click="OnOuvrirAide" ToolTip.Tip="{Binding Session.Tooltips[ui.help]}" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="10">
                <TextBlock Text="Consignes" Foreground="#F9FAFB" FontWeight="SemiBold" />
                <ItemsControl ItemsSource="{Binding Session.ConsignesBooking}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding .}" Foreground="#CBD5F5" TextWrapping="Wrap" />
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
                <Grid ColumnDefinitions="2*,3*" ColumnSpacing="12">
                  <StackPanel Grid.Column="0" Spacing="6">
                    <TextBlock Text="Timeline" Foreground="#F9FAFB" FontWeight="SemiBold" />
                    <ListBox ItemsSource="{Binding Session.Segments}"
                             SelectedItem="{Binding Session.SegmentSelectionne, Mode=TwoWay}"
                             MaxHeight="380">
                      <ListBox.ItemTemplate>
                        <DataTemplate>
                          <Border Background="#0F172A" Padding="8" CornerRadius="6" Margin="0,4,0,4">
                            <StackPanel Spacing="6">
                              <Grid ColumnDefinitions="*,Auto">
                                <StackPanel Spacing="2">
                                  <TextBlock Text="{Binding TypeSegmentLibelle}" Foreground="#E5E7EB" FontWeight="SemiBold" />
                                  <TextBlock Text="{Binding DureeMinutes, StringFormat='Durée {0} min'}" Foreground="#94A3B8" />
                                  <TextBlock Text="{Binding Participants.Count, StringFormat='Participants {0}'}" Foreground="#94A3B8" />
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                                  <Button Content="↑" Click="OnDeplacerSegmentHaut" Tag="{Binding .}" />
                                  <Button Content="↓" Click="OnDeplacerSegmentBas" Tag="{Binding .}" />
                                  <Button Content="Copier" Click="OnCopierSegment" Tag="{Binding .}" />
                                  <Button Content="Dupliquer match" Click="OnDupliquerMatch" Tag="{Binding .}" />
                                  <Button Content="Supprimer" Click="OnSupprimerSegment" Tag="{Binding .}" />
                                </StackPanel>
                              </Grid>
                              <TextBlock Text="{Binding Avertissements}" Foreground="#FBBF24" TextWrapping="Wrap" />
                            </StackPanel>
                          </Border>
                        </DataTemplate>
                      </ListBox.ItemTemplate>
                    </ListBox>
                    <Border Background="#1F2937" Padding="8" CornerRadius="6">
                      <StackPanel Spacing="6">
                        <TextBlock Text="Ajouter un segment" Foreground="#F9FAFB" FontWeight="SemiBold" />
                        <Grid ColumnDefinitions="160,80,*,90,120">
                          <ComboBox ItemsSource="{Binding Session.SegmentTypes}"
                                    SelectedValuePath="Id"
                                    DisplayMemberPath="Label"
                                    SelectedValue="{Binding Session.NouveauSegmentTypeId, Mode=TwoWay}" />
                          <TextBox Grid.Column="1" Text="{Binding Session.NouveauSegmentDuree, Mode=TwoWay}" />
                          <StackPanel Grid.Column="2" Spacing="4">
                            <ItemsControl ItemsSource="{Binding Session.NouveauSegmentParticipants}">
                              <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                  <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="{Binding Nom}" Foreground="#E5E7EB" />
                                    <Button Content="Retirer" Click="OnRetirerParticipantNouveauSegment" />
                                  </StackPanel>
                                </DataTemplate>
                              </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                              <ComboBox Width="180"
                                        ItemsSource="{Binding Session.WorkersDisponibles}"
                                        SelectedValuePath="WorkerId"
                                        DisplayMemberPath="Nom"
                                        SelectedValue="{Binding Session.NouveauSegmentParticipantId, Mode=TwoWay}" />
                              <Button Content="Ajouter" Click="OnAjouterParticipantNouveauSegment" />
                            </StackPanel>
                          </StackPanel>
                          <CheckBox Grid.Column="3" IsChecked="{Binding Session.NouveauSegmentMainEvent, Mode=TwoWay}" />
                          <Button Grid.Column="4" Content="Ajouter" Click="OnAjouterSegment" />
                        </Grid>
                      </StackPanel>
                    </Border>
                  </StackPanel>
                  <Border Grid.Column="1" Background="#1F2937" Padding="10" CornerRadius="6">
                    <StackPanel Spacing="8" DataContext="{Binding Session.SegmentSelectionne}">
                      <TextBlock Text="Détails du segment" Foreground="#F9FAFB" FontWeight="SemiBold" />
                      <StackPanel Spacing="6">
                        <Grid ColumnDefinitions="140,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="6">
                          <TextBlock Text="Type" Foreground="#CBD5F5" />
                          <ComboBox Grid.Column="1"
                                    ItemsSource="{Binding DataContext.Session.SegmentTypes, RelativeSource={RelativeSource AncestorType=Window}}"
                                    SelectedValuePath="Id"
                                    DisplayMemberPath="Label"
                                    SelectedValue="{Binding TypeSegment, Mode=TwoWay}" />
                          <TextBlock Grid.Row="1" Text="Durée" Foreground="#CBD5F5" />
                          <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding DureeMinutes, Mode=TwoWay}" />
                          <TextBlock Grid.Row="2" Text="Main event" Foreground="#CBD5F5" />
                          <CheckBox Grid.Row="2" Grid.Column="1" IsChecked="{Binding EstMainEvent, Mode=TwoWay}" />
                          <TextBlock Grid.Row="3" Text="Storyline" Foreground="#CBD5F5" />
                          <ComboBox Grid.Row="3" Grid.Column="1"
                                    ItemsSource="{Binding DataContext.Session.StorylinesDisponibles, RelativeSource={RelativeSource AncestorType=Window}}"
                                    SelectedValuePath="StorylineId"
                                    DisplayMemberPath="Nom"
                                    SelectedValue="{Binding StorylineId, Mode=TwoWay}" />
                          <TextBlock Grid.Row="4" Text="Titre" Foreground="#CBD5F5" />
                          <ComboBox Grid.Row="4" Grid.Column="1"
                                    ItemsSource="{Binding DataContext.Session.TitresDisponibles, RelativeSource={RelativeSource AncestorType=Window}}"
                                    SelectedValuePath="TitreId"
                                    DisplayMemberPath="Nom"
                                    SelectedValue="{Binding TitreId, Mode=TwoWay}" />
                        </Grid>
                        <TextBlock Text="Participants" Foreground="#F9FAFB" FontWeight="SemiBold" />
                        <ItemsControl ItemsSource="{Binding Participants}">
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="{Binding Nom}" Foreground="#E5E7EB" />
                                <Button Content="Retirer"
                                        Click="OnRetirerParticipant"
                                        Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=ItemsControl}}" />
                              </StackPanel>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        <StackPanel Orientation="Horizontal" Spacing="6">
                          <ComboBox Width="200"
                                    ItemsSource="{Binding DataContext.Session.WorkersDisponibles, RelativeSource={RelativeSource AncestorType=Window}}"
                                    SelectedValuePath="WorkerId"
                                    DisplayMemberPath="Nom"
                                    SelectedValue="{Binding ParticipantSelectionneeId, Mode=TwoWay}" />
                          <Button Content="Ajouter" Click="OnAjouterParticipant" />
                        </StackPanel>
                        <TextBlock Text="Consignes" Foreground="#F9FAFB" FontWeight="SemiBold" />
                        <ItemsControl ItemsSource="{Binding Consignes}">
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{Binding Libelle}" Foreground="#CBD5F5" Width="160" />
                                <ComboBox ItemsSource="{Binding Options}"
                                          SelectedItem="{Binding Selection, Mode=TwoWay}" />
                              </StackPanel>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        <Button Content="Enregistrer les modifications"
                                HorizontalAlignment="Left"
                                Click="OnEnregistrerSegment"
                                Tag="{Binding .}" />
                      </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="6">
                      <ComboBox Width="220"
                                ItemsSource="{Binding Session.SegmentTemplates}"
                                DisplayMemberPath="Libelle"
                                SelectedItem="{Binding Session.TemplateSelectionnee, Mode=TwoWay}" />
                      <Button Content="Ajouter depuis bibliothèque" Click="OnAjouterDepuisBibliotheque" />
                    </StackPanel>
                  </StackPanel>
                </Border>
                </Grid>
                <Border Background="#1F2937" Padding="8" CornerRadius="6">
                  <StackPanel Spacing="6">
                    <TextBlock Text="Ajouter depuis bibliothèque" Foreground="#F9FAFB" FontWeight="SemiBold" />
                    <Grid ColumnDefinitions="*,120">
                      <ComboBox ItemsSource="{Binding Session.SegmentTemplates}"
                                SelectedItem="{Binding Session.TemplateSelectionnee, Mode=TwoWay}"
                                DisplayMemberPath="Nom" />
                      <Button Grid.Column="1" Content="Ajouter" Click="OnAppliquerTemplate" />
                    </Grid>
                    <TextBlock Text="{Binding Session.TemplateSelectionnee.Resume}" Foreground="#9CA3AF" TextWrapping="Wrap" />
                  </StackPanel>
                </Border>
              </StackPanel>
            </Border>
            <StackPanel Orientation="Horizontal" Spacing="12">
              <Button Content="Simuler le show" Click="OnSimulerShow" ToolTip.Tip="{Binding Session.Tooltips[booking.simuler]}" />
              <Button Content="Semaine suivante" Click="OnSemaineSuivante" ToolTip.Tip="{Binding Session.Tooltips[booking.semaine]}" />
            </StackPanel>
            <Border Background="#111827" Padding="10" CornerRadius="8">
              <StackPanel Spacing="6">
                <TextBlock Text="Validation" Foreground="#F9FAFB" FontWeight="SemiBold" />
                <ItemsControl ItemsSource="{Binding Session.ValidationIssues}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="#0F172A" Padding="8" CornerRadius="6">
                        <Grid ColumnDefinitions="*,Auto">
                          <TextBlock Text="{Binding Message}" Foreground="#FBBF24" TextWrapping="Wrap" />
                          <Button Grid.Column="1"
                                  Content="{Binding ActionLabel}"
                                  Click="OnCorrigerIssue"
                                  Tag="{Binding .}" />
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
                <TextBlock Text="{Binding Session.ValidationErreurs}" Foreground="#F87171" TextWrapping="Wrap" />
                <TextBlock Text="{Binding Session.ValidationAvertissements}" Foreground="#FBBF24" TextWrapping="Wrap" ToolTip.Tip="{Binding Session.Tooltips['booking.warning']}" />
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Storylines" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="page.storylines" Click="OnOuvrirAide" ToolTip.Tip="{Binding Session.Tooltips['ui.help']}" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <Grid ColumnDefinitions="2*,*">
                <StackPanel Spacing="6">
                  <Grid ColumnDefinitions="2*,*,80,2*,*">
                    <TextBlock Text="Titre" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="1" Text="Phase" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="2" Text="Heat" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="3" Text="Participants" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="4" Text="Statut" Foreground="#9CA3AF" />
                  </Grid>
                  <ListBox ItemsSource="{Binding Session.Storylines}" SelectedItem="{Binding Session.StorylineSelectionnee, Mode=TwoWay}" MaxHeight="240">
                    <ListBox.ItemTemplate>
                      <DataTemplate>
                        <Border Background="#0F172A" Padding="8" CornerRadius="6" Margin="0,4,0,4">
                          <Grid ColumnDefinitions="2*,*,80,2*,*">
                            <TextBlock Text="{Binding Nom}" Foreground="White" />
                            <TextBlock Grid.Column="1" Text="{Binding Phase}" Foreground="#CBD5F5" />
                            <TextBlock Grid.Column="2" Text="{Binding Heat}" Foreground="#FCD34D" />
                            <TextBlock Grid.Column="3" Text="{Binding ParticipantsResume}" Foreground="#E5E7EB" TextWrapping="Wrap" />
                            <TextBlock Grid.Column="4" Text="{Binding Statut}" Foreground="#93C5FD" />
                          </Grid>
                        </Border>
                      </DataTemplate>
                    </ListBox.ItemTemplate>
                  </ListBox>
                </StackPanel>

                <Border Grid.Column="1" Background="#0F172A" Padding="12" CornerRadius="8" Margin="12,0,0,0">
                  <StackPanel Spacing="8">
                    <TextBlock Text="Détails storyline" Foreground="#F9FAFB" FontWeight="SemiBold" />
                    <TextBox Watermark="Nom" Text="{Binding Session.StorylineNom, Mode=TwoWay}" />
                    <ComboBox ItemsSource="{Binding Session.StorylinePhases}"
                              SelectedItem="{Binding Session.StorylinePhaseSelection, Mode=TwoWay}"
                              DisplayMemberPath="Libelle" />
                    <ComboBox ItemsSource="{Binding Session.StorylineStatuts}"
                              SelectedItem="{Binding Session.StorylineStatutSelection, Mode=TwoWay}"
                              DisplayMemberPath="Libelle" />
                    <TextBox Watermark="Résumé" Text="{Binding Session.StorylineResume, Mode=TwoWay}" AcceptsReturn="True" Height="60" />
                    <StackPanel Spacing="4">
                      <TextBlock Text="Participants" Foreground="#CBD5F5" />
                      <ItemsControl ItemsSource="{Binding Session.StorylineParticipantsEdition}">
                        <ItemsControl.ItemTemplate>
                          <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="6">
                              <TextBlock Text="{Binding Resume}" Foreground="#E5E7EB" />
                              <Button Content="Retirer" Click="OnRetirerParticipantStoryline" />
                            </StackPanel>
                          </DataTemplate>
                        </ItemsControl.ItemTemplate>
                      </ItemsControl>
                      <StackPanel Orientation="Horizontal" Spacing="6">
                        <ComboBox Width="180"
                                  ItemsSource="{Binding Session.WorkersDisponibles}"
                                  SelectedValuePath="WorkerId"
                                  DisplayMemberPath="Nom"
                                  SelectedValue="{Binding Session.StorylineParticipantSelectionId, Mode=TwoWay}" />
                        <Button Content="Ajouter" Click="OnAjouterParticipantStoryline" />
                      </StackPanel>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="6">
                      <Button Content="Créer" Click="OnCreerStoryline" />
                      <Button Content="Mettre à jour" Click="OnMettreAJourStoryline" />
                      <Button Content="Avancer" Click="OnAvancerStoryline" />
                      <Button Content="Supprimer" Click="OnSupprimerStoryline" />
                    </StackPanel>
                  </StackPanel>
                </Border>
              </Grid>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Bibliothèque" FontSize="20" FontWeight="Bold" Foreground="White" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="8">
                <ItemsControl ItemsSource="{Binding Session.SegmentTemplates}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="#0F172A" Padding="8" CornerRadius="6" Margin="0,4,0,4">
                        <StackPanel Spacing="4">
                          <TextBlock Text="{Binding Libelle}" Foreground="White" FontWeight="SemiBold" />
                          <TextBlock Text="{Binding Description}" Foreground="#CBD5F5" TextWrapping="Wrap" />
                          <TextBlock Text="{Binding SegmentsResume}" Foreground="#9CA3AF" TextWrapping="Wrap" />
                          <Button Content="Appliquer" Click="OnAppliquerTemplateBibliotheque" Tag="{Binding .}" />
                        </StackPanel>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Bibliothèque" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="page.segments" Click="OnOuvrirAide" ToolTip.Tip="{Binding Session.Tooltips['ui.help']}" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <Grid ColumnDefinitions="2*,*" ColumnSpacing="12">
                <StackPanel Spacing="6">
                  <TextBlock Text="Templates de segments" Foreground="#F9FAFB" FontWeight="SemiBold" />
                  <ListBox ItemsSource="{Binding Session.SegmentTemplates}"
                           SelectedItem="{Binding Session.TemplateSelectionnee, Mode=TwoWay}"
                           MaxHeight="220">
                    <ListBox.ItemTemplate>
                      <DataTemplate>
                        <Border Background="#0F172A" Padding="8" CornerRadius="6">
                          <StackPanel>
                            <TextBlock Text="{Binding Nom}" Foreground="White" FontWeight="SemiBold" />
                            <TextBlock Text="{Binding Resume}" Foreground="#9CA3AF" TextWrapping="Wrap" />
                          </StackPanel>
                        </Border>
                      </DataTemplate>
                    </ListBox.ItemTemplate>
                  </ListBox>
                  <Button Content="Appliquer" Click="OnAppliquerTemplate" />
                </StackPanel>
                <StackPanel Grid.Column="1" Spacing="6">
                  <TextBlock Text="Types de match" Foreground="#F9FAFB" FontWeight="SemiBold" />
                  <ItemsControl ItemsSource="{Binding Session.MatchTypes}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="#0F172A" Padding="6" CornerRadius="6" Margin="0,0,0,6">
                          <StackPanel Orientation="Horizontal" Spacing="8">
                            <CheckBox IsChecked="{Binding EstActif, Mode=TwoWay}" VerticalAlignment="Center" />
                            <StackPanel>
                              <TextBlock Text="{Binding Nom}" Foreground="White" FontWeight="SemiBold" />
                              <TextBlock Text="{Binding Description}" Foreground="#9CA3AF" TextWrapping="Wrap" />
                            </StackPanel>
                          </StackPanel>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </Grid>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Résultats" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="page.resultats" Click="OnOuvrirAide" ToolTip.Tip="{Binding Session.Tooltips['ui.help']}" />
            </Grid>
            <TextBlock Text="{Binding Session.ResumeShow}" Foreground="#CBD5F5" />
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="6">
                <Grid ColumnDefinitions="140,70,200,70,*,*">
                  <TextBlock Text="Segment" Foreground="#9CA3AF" />
                  <TextBlock Grid.Column="1" Text="Note" Foreground="#9CA3AF" ToolTip.Tip="{Binding Session.Tooltips['result.note']}" />
                  <TextBlock Grid.Column="2" Text="Ratings" Foreground="#9CA3AF" />
                  <TextBlock Grid.Column="3" Text="Icônes" Foreground="#9CA3AF" />
                  <TextBlock Grid.Column="4" Text="Breakdown" Foreground="#9CA3AF" ToolTip.Tip="{Binding Session.Tooltips['result.breakdown']}" />
                  <TextBlock Grid.Column="5" Text="Impacts" Foreground="#9CA3AF" ToolTip.Tip="{Binding Session.Tooltips['result.impacts']}" />
                </Grid>
                <ListBox ItemsSource="{Binding Session.Resultats}" SelectedItem="{Binding Session.ResultatSelectionne, Mode=TwoWay}">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Grid ColumnDefinitions="140,70,200,70,*,*">
                        <TextBlock Text="{Binding TypeSegment}" Foreground="White" />
                        <TextBlock Grid.Column="1" Text="{Binding Note}" Foreground="#FCD34D" ToolTip.Tip="{Binding DataContext.Session.Tooltips['result.note'], RelativeSource={RelativeSource AncestorType=Window}}" />
                        <TextBlock Grid.Column="2" Text="{Binding Ratings}" Foreground="#E5E7EB" TextWrapping="Wrap" />
                        <TextBlock Grid.Column="3" Text="{Binding Icons}" Foreground="#FBBF24" />
                        <TextBlock Grid.Column="4" Text="{Binding Breakdown}" Foreground="#E5E7EB" TextWrapping="Wrap" />
                        <TextBlock Grid.Column="5" Text="{Binding Impacts}" Foreground="#D1D5DB" TextWrapping="Wrap" />
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </StackPanel>
            </Border>
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Button Content="Ouvrir fiche worker" Click="OnOuvrirFicheWorker" />
              <Button Content="Voir impacts" Click="OnVoirImpacts" />
              <Button Content="Voir finance" Click="OnVoirFinance" />
            </StackPanel>
            <StackPanel Spacing="6">
              <TextBlock Text="Actions rapides" Foreground="#F9FAFB" FontWeight="SemiBold" />
              <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Content="Ouvrir fiche worker" Tag="{Binding Session.ResultatSelectionne.PremierParticipantId}" Click="OnOuvrirFicheWorker" />
                <Button Content="Voir impacts" Tag="impacts.popularite" Click="OnOuvrirImpact" />
                <Button Content="Voir finance" Tag="impacts.finances" Click="OnOuvrirImpact" />
              </StackPanel>
            </StackPanel>
            <StackPanel Spacing="6">
              <TextBlock Text="Audience" Foreground="#F9FAFB" FontWeight="SemiBold" />
              <TextBlock Text="{Binding Session.AudienceResume}" Foreground="#E5E7EB" />
              <Border Background="#111827" Padding="8" CornerRadius="6">
                <StackPanel Spacing="4">
                  <Grid ColumnDefinitions="80,80,80">
                    <TextBlock Text="Semaine" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="1" Text="Audience" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="2" Text="Évolution" Foreground="#9CA3AF" />
                  </Grid>
                  <ItemsControl ItemsSource="{Binding Session.AudienceHistorique}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Grid ColumnDefinitions="80,80,80">
                          <TextBlock Text="{Binding Semaine}" Foreground="#E5E7EB" />
                          <TextBlock Grid.Column="1" Text="{Binding Audience}" Foreground="#FCD34D" />
                          <TextBlock Grid.Column="2" Text="{Binding Evolution}" Foreground="#A7F3D0" />
                        </Grid>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </Border>
            </StackPanel>
            <StackPanel Spacing="6">
              <TextBlock Text="Pourquoi cette note ?" Foreground="#F9FAFB" FontWeight="SemiBold" />
              <ItemsControl ItemsSource="{Binding Session.PourquoiNote}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding .}" Foreground="#E5E7EB" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <StackPanel Spacing="6">
              <TextBlock Text="Récap FM" Foreground="#F9FAFB" FontWeight="SemiBold" />
              <ItemsControl ItemsSource="{Binding Session.RecapFm}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding .}" Foreground="#E5E7EB" TextWrapping="Wrap" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <StackPanel Spacing="6">
              <TextBlock Text="Historique du show" Foreground="#F9FAFB" FontWeight="SemiBold" />
              <ItemsControl ItemsSource="{Binding Session.HistoriqueShow}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding Ligne}" Foreground="#CBD5F5" TextWrapping="Wrap" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <StackPanel Spacing="6">
              <TextBlock Text="Conseils" Foreground="#F9FAFB" FontWeight="SemiBold" />
              <ItemsControl ItemsSource="{Binding Session.Conseils}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding .}" Foreground="#CBD5F5" TextWrapping="Wrap" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <StackPanel Spacing="6">
              <Button Content="Détails simulation" Click="OnToggleDetailsSimulation" />
              <TextBlock Text="{Binding Session.DetailsSimulation}" IsVisible="{Binding Session.DetailsSimulationVisible}" Foreground="#9CA3AF" TextWrapping="Wrap" />
            </StackPanel>
            <StackPanel Spacing="6">
              <TextBlock Text="Aller aux impacts" Foreground="#F9FAFB" FontWeight="SemiBold" />
              <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Content="Popularité" Tag="impacts.popularite" Click="OnOuvrirImpact" />
                <Button Content="Finances" Tag="impacts.finances" Click="OnOuvrirImpact" />
                <Button Content="Fatigue/Blessures" Tag="impacts.fatigue" Click="OnOuvrirImpact" />
                <Button Content="Storylines" Tag="impacts.storylines" Click="OnOuvrirImpact" />
                <Button Content="Titres" Tag="impacts.titres" Click="OnOuvrirImpact" />
              </StackPanel>
            </StackPanel>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Diffusion" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="page.diffusion" Click="OnOuvrirAide" ToolTip.Tip="{Binding Session.Tooltips['ui.help']}" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="12">
                <StackPanel Spacing="6">
                  <TextBlock Text="Deals TV" Foreground="#F9FAFB" FontWeight="SemiBold" />
                  <Grid ColumnDefinitions="160,80,80,100,100,*">
                    <TextBlock Text="Diffuseur" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="1" Text="Reach" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="2" Text="Cap" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="3" Text="Fixe" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="4" Text="Par point" Foreground="#9CA3AF" />
                    <TextBlock Grid.Column="5" Text="Contraintes" Foreground="#9CA3AF" />
                  </Grid>
                  <ItemsControl ItemsSource="{Binding Session.DealsTv}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Grid ColumnDefinitions="160,80,80,100,100,*">
                          <TextBlock Text="{Binding Diffuseur}" Foreground="#E5E7EB" />
                          <TextBlock Grid.Column="1" Text="{Binding ReachBonus}" Foreground="#38BDF8" />
                          <TextBlock Grid.Column="2" Text="{Binding AudienceCap}" Foreground="#FCD34D" />
                          <TextBlock Grid.Column="3" Text="{Binding RevenuBase}" Foreground="#34D399" />
                          <TextBlock Grid.Column="4" Text="{Binding RevenuParPoint}" Foreground="#93C5FD" />
                          <TextBlock Grid.Column="5" Text="{Binding Contraintes}" Foreground="#D1D5DB" TextWrapping="Wrap" />
                        </Grid>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Reach map" Foreground="#F9FAFB" FontWeight="SemiBold" />
                  <ItemsControl ItemsSource="{Binding Session.ReachMap}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Grid ColumnDefinitions="200,80,*">
                          <TextBlock Text="{Binding Zone}" Foreground="#E5E7EB" />
                          <TextBlock Grid.Column="1" Text="{Binding Reach}" Foreground="#FCD34D" />
                          <TextBlock Grid.Column="2" Text="{Binding Details}" Foreground="#9CA3AF" TextWrapping="Wrap" />
                        </Grid>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Contraintes" Foreground="#F9FAFB" FontWeight="SemiBold" />
                  <ItemsControl ItemsSource="{Binding Session.ContraintesDiffusion}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding .}" Foreground="#E5E7EB" TextWrapping="Wrap" />
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="FM UI Kit · TableView" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="ui.tableview" Click="OnOuvrirAide" ToolTip.Tip="Présentation de la table virtualisée, tri, filtres et colonnes personnalisables." />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="12">
                <StackPanel Orientation="Horizontal" Spacing="12">
                  <TextBox Width="240" Watermark="Rechercher dans la table" Text="{Binding Session.TableRecherche, Mode=TwoWay}"
                           ToolTip.Tip="Recherche rapide par nom, rôle, statut ou type." />
                  <ComboBox Width="180" ItemsSource="{Binding Session.TableTypeFilters}" SelectedItem="{Binding Session.TableSelectedTypeFilter, Mode=TwoWay}"
                            DisplayMemberPath="Libelle" ToolTip.Tip="Filtrer par type de fiche." />
                  <ComboBox Width="180" ItemsSource="{Binding Session.TableStatusFilters}" SelectedItem="{Binding Session.TableSelectedStatusFilter, Mode=TwoWay}"
                            DisplayMemberPath="Libelle" ToolTip.Tip="Filtrer par statut opérationnel." />
                  <TextBlock Text="{Binding Session.TableResultatsResume}" Foreground="#9CA3AF" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="12">
                  <TextBlock Text="{Binding Session.TableTriResume}" Foreground="#9CA3AF" VerticalAlignment="Center" />
                  <Button Content="Réinitialiser tri" Click="OnReinitialiserTriTable" ToolTip.Tip="Effacer tous les tris multi-colonnes." />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="12">
                  <TextBlock Text="Colonnes" Foreground="#9CA3AF" VerticalAlignment="Center" />
                  <CheckBox Content="Type" IsChecked="{Binding Session.TableConfiguration.AfficherType}" ToolTip.Tip="Afficher la colonne Type." />
                  <CheckBox Content="Compagnie" IsChecked="{Binding Session.TableConfiguration.AfficherCompagnie}" ToolTip.Tip="Afficher la colonne Compagnie." />
                  <CheckBox Content="Rôle" IsChecked="{Binding Session.TableConfiguration.AfficherRole}" ToolTip.Tip="Afficher la colonne Rôle/Participants." />
                  <CheckBox Content="Statut" IsChecked="{Binding Session.TableConfiguration.AfficherStatut}" ToolTip.Tip="Afficher la colonne Statut." />
                  <CheckBox Content="Popularité" IsChecked="{Binding Session.TableConfiguration.AfficherPopularite}" ToolTip.Tip="Afficher la colonne Popularité." />
                  <CheckBox Content="Momentum" IsChecked="{Binding Session.TableConfiguration.AfficherMomentum}" ToolTip.Tip="Afficher la colonne Momentum." />
                  <CheckBox Content="Note" IsChecked="{Binding Session.TableConfiguration.AfficherNote}" ToolTip.Tip="Afficher la colonne Note synthétique." />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="12">
                  <TextBlock Text="Ordre" Foreground="#9CA3AF" VerticalAlignment="Center" />
                  <ItemsControl ItemsSource="{Binding Session.TableColumns}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <WrapPanel />
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="#0F172A" Padding="6,2" CornerRadius="6" Margin="2">
                          <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="{Binding Libelle}" Foreground="#E5E7EB" />
                            <Button Content="↑" Tag="{Binding .}" Click="OnTableColumnUp" Padding="4,0" MinWidth="20" />
                            <Button Content="↓" Tag="{Binding .}" Click="OnTableColumnDown" Padding="4,0" MinWidth="20" />
                          </StackPanel>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="12">
                  <TextBlock Text="Actions rapides" Foreground="#9CA3AF" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding Session.TableSelectionContexte}" Foreground="#E5E7EB" VerticalAlignment="Center" />
                  <Button Content="Assigner" IsEnabled="{Binding Session.TableSelectionDisponible}" ToolTip.Tip="Assigner la fiche sélectionnée à un segment." />
                  <Button Content="Mettre en avant" IsEnabled="{Binding Session.TableSelectionDisponible}" ToolTip.Tip="Mettre en avant la fiche dans le show." />
                  <Button Content="Planifier" IsEnabled="{Binding Session.TableSelectionDisponible}" ToolTip.Tip="Planifier une action rapide." />
                  <Button Content="Favori" IsEnabled="{Binding Session.TableSelectionDisponible}" ToolTip.Tip="Ajouter aux favoris." />
                </StackPanel>

                <Grid ColumnDefinitions="2*,*" RowDefinitions="Auto">
                  <controls:DataGrid x:Name="TableViewGrid"
                            ItemsSource="{Binding Session.TableItemsView}" SelectedItem="{Binding Session.TableSelection, Mode=TwoWay}"
                            Height="320"
                            AutoGenerateColumns="False"
                            CanUserSortColumns="True"
                            CanUserReorderColumns="True"
                            GridLinesVisibility="All"
                            HeadersVisibility="All"
                            IsReadOnly="True"
                            EnableColumnVirtualization="True"
                            EnableRowVirtualization="True"
                            Sorting="OnTableSorting"
                            ToolTip.Tip="Table virtualisée avec tri, filtres et recherche.">
                    <controls:DataGrid.Columns>
                      <controls:DataGridTextColumn Header="Nom" Tag="Nom" Binding="{Binding Nom}" Width="2*" SortMemberPath="Nom" />
                      <controls:DataGridTextColumn Header="Type" Tag="Type" Binding="{Binding Type}" Width="*" SortMemberPath="Type"
                                          IsVisible="{Binding DataContext.Session.TableConfiguration.AfficherType, RelativeSource={RelativeSource AncestorType=Window}}" />
                      <controls:DataGridTextColumn Header="Compagnie" Tag="Compagnie" Binding="{Binding Compagnie}" Width="*" SortMemberPath="Compagnie"
                                          IsVisible="{Binding DataContext.Session.TableConfiguration.AfficherCompagnie, RelativeSource={RelativeSource AncestorType=Window}}" />
                      <controls:DataGridTextColumn Header="Rôle/Participants" Tag="Role" Binding="{Binding Role}" Width="2*" SortMemberPath="Role"
                                          IsVisible="{Binding DataContext.Session.TableConfiguration.AfficherRole, RelativeSource={RelativeSource AncestorType=Window}}" />
                      <controls:DataGridTextColumn Header="Statut" Tag="Statut" Binding="{Binding Statut}" Width="*" SortMemberPath="Statut"
                                          IsVisible="{Binding DataContext.Session.TableConfiguration.AfficherStatut, RelativeSource={RelativeSource AncestorType=Window}}" />
                      <controls:DataGridTextColumn Header="Popularité" Tag="Popularite" Binding="{Binding Popularite}" Width="*" SortMemberPath="Popularite"
                                          IsVisible="{Binding DataContext.Session.TableConfiguration.AfficherPopularite, RelativeSource={RelativeSource AncestorType=Window}}" />
                      <controls:DataGridTextColumn Header="Momentum" Tag="Momentum" Binding="{Binding Momentum}" Width="*" SortMemberPath="Momentum"
                                          IsVisible="{Binding DataContext.Session.TableConfiguration.AfficherMomentum, RelativeSource={RelativeSource AncestorType=Window}}" />
                      <controls:DataGridTextColumn Header="Note" Tag="Note" Binding="{Binding Note}" Width="*" SortMemberPath="Note"
                                          IsVisible="{Binding DataContext.Session.TableConfiguration.AfficherNote, RelativeSource={RelativeSource AncestorType=Window}}" />
                    </controls:DataGrid.Columns>
                  </controls:DataGrid>

                  <Border Grid.Column="1" Background="#0F172A" Padding="12" CornerRadius="8" Margin="12,0,0,0">
                    <StackPanel Spacing="6">
                      <TextBlock Text="Fiche courte" Foreground="#F9FAFB" FontWeight="SemiBold" />
                      <TextBlock Text="{Binding Session.TableSelection.Nom}" Foreground="White" FontSize="16" FontWeight="Bold" />
                      <TextBlock Text="{Binding Session.TableSelection.Type}" Foreground="#CBD5F5" />
                      <TextBlock Text="{Binding Session.TableSelection.Statut}" Foreground="#FCD34D" />
                      <TextBlock Text="{Binding Session.TableSelection.Resume}" Foreground="#D1D5DB" TextWrapping="Wrap" />
                      <ItemsControl ItemsSource="{Binding Session.TableSelection.Etiquettes}">
                        <ItemsControl.ItemsPanel>
                          <ItemsPanelTemplate>
                            <WrapPanel />
                          </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                          <DataTemplate>
                            <Border Background="#1F2937" Padding="6,2" Margin="2" CornerRadius="6">
                              <TextBlock Text="{Binding .}" Foreground="#E5E7EB" />
                            </Border>
                          </DataTemplate>
                        </ItemsControl.ItemTemplate>
                      </ItemsControl>
                    </StackPanel>
                  </Border>
                </Grid>
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <TextBlock Text="Profil (exemple)" FontSize="20" FontWeight="Bold" Foreground="White" />
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <ItemsControl ItemsSource="{Binding Session.AttributsPrincipaux}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Grid ColumnDefinitions="160,80">
                      <TextBlock Text="{Binding Libelle}" Foreground="#E5E7EB" ToolTip.Tip="{Binding Tooltip}" />
                      <TextBlock Grid.Column="1" Text="{Binding Valeur}" Foreground="#FCD34D" />
                    </Grid>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <TextBlock Text="Actions sensibles" FontSize="20" FontWeight="Bold" Foreground="White" />
            <StackPanel Orientation="Horizontal" Spacing="12">
              <Button Content="Buyout" ToolTip.Tip="{Binding Session.Tooltips['action.buyout']}" />
              <Button Content="LOD" ToolTip.Tip="{Binding Session.Tooltips['action.lod']}" />
              <Button Content="Diffusion" ToolTip.Tip="{Binding Session.Tooltips['action.diffusion']}" />
            </StackPanel>
          </StackPanel>

          <StackPanel Spacing="8">
            <TextBlock Text="Youth" FontSize="20" FontWeight="Bold" Foreground="White" />
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="10">
                <ComboBox ItemsSource="{Binding Session.YouthStructures}"
                          SelectedItem="{Binding Session.YouthStructureSelection}">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Nom}" />
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>

                <Grid ColumnDefinitions="160,*" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6" ColumnSpacing="12">
                  <TextBlock Text="Type" Foreground="#9CA3AF" />
                  <TextBlock Grid.Column="1" Text="{Binding Session.YouthStructureSelection.Type}" Foreground="#E5E7EB" />
                  <TextBlock Grid.Row="1" Text="Région" Foreground="#9CA3AF" />
                  <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Session.YouthStructureSelection.Region}" Foreground="#E5E7EB" />
                  <TextBlock Grid.Row="2" Text="Budget" Foreground="#9CA3AF" />
                  <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Session.YouthStructureSelection.BudgetAnnuel}" Foreground="#FCD34D" />
                  <TextBlock Grid.Row="3" Text="Capacité" Foreground="#9CA3AF" />
                  <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding Session.YouthStructureSelection.TraineesActifs}" Foreground="#E5E7EB" />
                </Grid>

                <StackPanel Spacing="6">
                  <TextBlock Text="Trainees" FontWeight="SemiBold" Foreground="#F9FAFB" />
                  <ItemsControl ItemsSource="{Binding Session.YouthTrainees}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Grid ColumnDefinitions="*,Auto" Margin="0,2">
                          <StackPanel>
                            <TextBlock Text="{Binding Nom}" Foreground="#E5E7EB" />
                            <TextBlock Text="{Binding InRing, StringFormat=In-Ring: {0}}"
                                       Foreground="#9CA3AF" />
                            <TextBlock Text="{Binding Entertainment, StringFormat=Entertainment: {0}}"
                                       Foreground="#9CA3AF" />
                            <TextBlock Text="{Binding Story, StringFormat=Story: {0}}"
                                       Foreground="#9CA3AF" />
                          </StackPanel>
                          <Button Grid.Column="1"
                                  Content="Graduation"
                                  Tag="{Binding WorkerId}"
                                  Click="OnGraduationYouth" />
                        </Grid>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Programmes" FontWeight="SemiBold" Foreground="#F9FAFB" />
                  <ItemsControl ItemsSource="{Binding Session.YouthPrograms}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Nom}" Foreground="#E5E7EB" />
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Staff" FontWeight="SemiBold" Foreground="#F9FAFB" />
                  <ItemsControl ItemsSource="{Binding Session.YouthStaffAssignments}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Nom}" Foreground="#E5E7EB" />
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Spacing="6">
                  <TextBlock Text="Actions" FontWeight="SemiBold" Foreground="#F9FAFB" />
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <NumericUpDown Width="140"
                                   Minimum="0"
                                   Maximum="500000"
                                   Value="{Binding Session.YouthBudgetNouveau}" />
                    <Button Content="Changer budget" Click="OnChangerBudgetYouth" />
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBox Width="140" Watermark="Worker ID" Text="{Binding Session.YouthCoachWorkerId}" />
                    <TextBox Width="160" Watermark="Rôle" Text="{Binding Session.YouthCoachRole}" />
                    <Button Content="Affecter coach" Click="OnAffecterCoachYouth" />
                  </StackPanel>
                  <TextBlock Text="{Binding Session.YouthActionMessage}" Foreground="#34D399" />
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <TextBlock Text="Génération automatique" FontSize="20" FontWeight="Bold" Foreground="White" />
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="8">
                <Grid ColumnDefinitions="160,*" RowDefinitions="Auto,Auto,Auto" RowSpacing="6" ColumnSpacing="12">
                  <TextBlock Text="Youth" Foreground="#9CA3AF" />
                  <ComboBox Grid.Column="1"
                            ItemsSource="{Binding Session.YouthGenerationModes}"
                            SelectedItem="{Binding Session.YouthGenerationSelection}">
                    <ComboBox.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Libelle}" />
                      </DataTemplate>
                    </ComboBox.ItemTemplate>
                  </ComboBox>
                  <TextBlock Grid.Row="1" Text="Monde" Foreground="#9CA3AF" />
                  <ComboBox Grid.Row="1" Grid.Column="1"
                            ItemsSource="{Binding Session.WorldGenerationModes}"
                            SelectedItem="{Binding Session.WorldGenerationSelection}">
                    <ComboBox.ItemTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Libelle}" />
                      </DataTemplate>
                    </ComboBox.ItemTemplate>
                  </ComboBox>
                  <TextBlock Grid.Row="2" Text="Semaine pivot" Foreground="#9CA3AF" />
                  <NumericUpDown Grid.Row="2" Grid.Column="1"
                                 Minimum="1"
                                 Maximum="52"
                                 Value="{Binding Session.SemainePivotAnnuelle}" />
                </Grid>
                <Button Content="Enregistrer les paramètres" Click="OnEnregistrerGeneration" />
                <TextBlock Text="{Binding Session.ParametresGenerationMessage}" Foreground="#34D399" />
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Impacts" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="impacts.popularite" Click="OnOuvrirAide" ToolTip.Tip="{Binding Session.Tooltips['ui.help']}" />
            </Grid>
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <StackPanel Spacing="6">
                <TextBlock Text="{Binding Session.ImpactSelectionnee.Titre}" Foreground="#F9FAFB" FontWeight="SemiBold" />
                <TextBlock Text="{Binding Session.ImpactSelectionnee.Pourquoi}" Foreground="#CBD5F5" TextWrapping="Wrap" />
                <TextBlock Text="{Binding Session.ImpactSelectionnee.CommentAmeliorer}" Foreground="#9CA3AF" TextWrapping="Wrap" />
                <ItemsControl ItemsSource="{Binding Session.ImpactSelectionnee.Deltas}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding .}" Foreground="#E5E7EB" />
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </StackPanel>
            </Border>
          </StackPanel>

          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="Aide / Codex" FontSize="20" FontWeight="Bold" Foreground="White" />
              <Button Grid.Column="1" Content="?" Tag="page.aide-codex" Click="OnOuvrirAide" ToolTip.Tip="{Binding Session.Tooltips['ui.help']}" />
            </Grid>
            <StackPanel Spacing="6">
              <TextBox Watermark="Rechercher un terme" Text="{Binding Session.Codex.Recherche, Mode=TwoWay}" ToolTip.Tip="{Binding Session.Tooltips['ui.search']}" />
              <Border Background="#111827" Padding="12" CornerRadius="8">
                <ItemsControl ItemsSource="{Binding Session.Codex.Articles}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding Titre}" Foreground="#E5E7EB" />
                        <TextBlock Text="{Binding Categorie}" Foreground="#9CA3AF" />
                        <Button Content="Ouvrir" Tag="{Binding Id}" Click="OnOuvrirArticle" ToolTip.Tip="{Binding DataContext.Session.Tooltips['ui.open-article'], RelativeSource={RelativeSource AncestorType=Window}}" />
                      </StackPanel>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </Border>
              <Border Background="#111827" Padding="12" CornerRadius="8">
                <StackPanel Spacing="6">
                  <TextBlock Text="{Binding Session.Codex.ArticleSelectionne.Titre}" Foreground="#F9FAFB" FontWeight="SemiBold" />
                  <TextBlock Text="{Binding Session.Codex.ArticleSelectionne.Contenu}" Foreground="#D1D5DB" TextWrapping="Wrap" />
                  <ItemsControl ItemsSource="{Binding Session.Codex.ArticleSelectionne.Liens}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Button Content="{Binding .}" Tag="{Binding .}" Click="OnOuvrirArticle" />
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </Border>
            </StackPanel>
          </StackPanel>

          <StackPanel Spacing="8">
            <TextBlock Text="Inbox" FontSize="20" FontWeight="Bold" Foreground="White" />
            <Border Background="#111827" Padding="12" CornerRadius="8">
              <ItemsControl ItemsSource="{Binding Session.Inbox}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Spacing="4" Margin="0,0,0,8">
                      <TextBlock Text="{Binding Titre}" Foreground="#F9FAFB" FontWeight="SemiBold" />
                      <TextBlock Text="{Binding Contenu}" Foreground="#E5E7EB" TextWrapping="Wrap" />
                      <TextBlock Text="{Binding Semaine, StringFormat='Semaine {0}'}" Foreground="#9CA3AF" FontSize="11" />
                    </StackPanel>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </Border>
          </StackPanel>
        </StackPanel>
      </ScrollViewer>
    </Border>

    <Border Grid.RowSpan="2" Grid.ColumnSpan="2" Background="#111827EE" IsVisible="{Binding Session.RechercheGlobaleVisible}" ZIndex="10">
      <Grid HorizontalAlignment="Center" VerticalAlignment="Center" Width="720">
        <Border Background="#0B1220" Padding="16" CornerRadius="12" BorderBrush="#1F2937" BorderThickness="1">
          <StackPanel Spacing="12">
            <DockPanel>
              <TextBlock Text="Recherche globale" Foreground="White" FontSize="18" FontWeight="Bold" DockPanel.Dock="Left" />
              <Button Content="Fermer" DockPanel.Dock="Right" Command="{Binding Session.FermerRechercheGlobaleCommand}" ToolTip.Tip="Fermer la recherche globale (Échap)." />
            </DockPanel>
            <TextBox Watermark="Rechercher workers, compagnies, titres ou storylines"
                     Text="{Binding Session.RechercheGlobaleQuery, Mode=TwoWay}"
                     ToolTip.Tip="Tapez un nom, un titre ou un mot-clé." />
            <Border Background="#111827" Padding="8" CornerRadius="8">
              <StackPanel Spacing="6">
                <ItemsControl ItemsSource="{Binding Session.RechercheGlobaleResultats}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="#0F172A" Padding="8" CornerRadius="6" Margin="0,0,0,6">
                        <Grid ColumnDefinitions="120,*,Auto">
                          <TextBlock Text="{Binding Type}" Foreground="#9CA3AF" />
                          <StackPanel Grid.Column="1">
                            <TextBlock Text="{Binding Titre}" Foreground="White" FontWeight="SemiBold" />
                            <TextBlock Text="{Binding SousTitre}" Foreground="#CBD5F5" />
                          </StackPanel>
                          <TextBlock Grid.Column="2" Text="{Binding Statut}" Foreground="#FCD34D" VerticalAlignment="Center" />
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
                <TextBlock Text="Aucun résultat." Foreground="#9CA3AF"
                           IsVisible="{Binding Session.RechercheGlobaleAucunResultat}" />
              </StackPanel>
            </Border>
          </StackPanel>
        </Border>
      </Grid>
    </Border>
  </Grid>
</Window>
